# ICRC-25: Wallet Interaction Standard

## Summary

This specification describes a communication protocol between dapps (decentralized applications) and wallets. It defines messages that both sides should use to interact with each other and provides guidelines on how to process them.

## Terminology

* wallet: A service that manages a user's keys and can sign and perform canister calls on their behalf.
* relying party: A service that wants to request calls on a specific canister.

## Messages

### `permission`

The purpose of the `permission` messages is to establish a connection between a relying party and a wallet, grant the relying party access to public parts of the user's identity and define the scope of actions the relying part is allowed to perform.

#### Types

- `text`: A plain `string` value.
- `blob`: A `string` value describing binary data encoded in base64.

#### Request

`version` (`text`): The version of the standard used.

`appMetadata`: Information about the relying party.
- `name` (`text`): The user-friendly name of the relying party. 
- `icon` (`text`, optional): An optional URL pointing to an icon resource representing the relying party.

`networks`: A list of networks on which the relying party plans to operate.
- `chainId`(`text`): The chain id of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`scopes`: A list of permission scopes the relying party requires. Possible values: 
- `"canister_call"`

`challenge` (`blob`): A challenge used for the wallet to sign in order to prove its access to the identity. The challenge should be an array of 32 cryptographically random bytes generated from a secure random source by the sender of the request.

#### Response

`version` (`text`): The version of the standard used.

`appMetadata`: Information about the wallet.
- `name` (`text`): The user-friendly name of the wallet.
- `icon` (`text`, optional): An optional URL poiting to an icon resource representing the wallet.

`networks`: A list of networks on which the user has agreed the relying party can operate. This should be a subset of the `networks` from the original request.
- `chainId` (`text`): The chain id of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`scopes`: A list of permission scopes that the user has agreed the relying party can be granted. This should be a subset of the `scopes` field from the original request. Possible values:
- `"canister_call"`

`identity`: The identity the user has selected.
- `publicKey` (`blob`): The DER-encoded public key associated with the identity. The public key can be used to [derive a self-authenticating principal](https://internetcomputer.org/docs/current/references/ic-interface-spec/#principal).
- `ledger` (optional): Ledger data.
    - `subaccount` (`blob`, optional)

`signature` (`blob`): The signature produced by signing the concatenation of the domain separator `\x0Aic-wallet-challenge` and the challenge with the private key associated with the `identity`.

#### Use-Case

1. The relying party sends a `permission` request to the wallet.
2. Upon receiving the message, the wallet presents the details of the to-be-established connection to the user and asks the user to select the identity that will be paired in response.
    - If the user approves the request, the wallet sends a succesful response back to the relying party.
    - If the user rejects the request, the wallet sends a response with an error back to the relying party.
3. After receiving a succesful response, the relying party verifies that the wallet has access to the private key associated with the provided identity:
    - The relying party retrieves the `publicKey` from `identity`, determines the `signature` scheme and verifies whether it was generated by signing the concatenation of the domain separator `\x0Aic-wallet-challenge` and the `challenge` from the request with the private key associated with the `publicKey`.
        - If the signature verification succeeds, the relying party accepts the connection.
        - If the signature verificaiton fails, the relying party rejects the connection.

#### Example

```json
// Request
{
    "id": 1,
    "jsonrpc": "2.0",
    "method": "permission",
    "params": {
        "version": "1",
        "appMetadata": {
            "name": "My DApp"
        },
        "networks": [{
            "chainId": "icp:737ba355e855bd4b61279056603e0550",
        }],
        "scopes": ["canister_call"],
        "challenge": "UjwgsORvEzp98TmB1cAIseNOoD9+GLyN/1DzJ5+jxZM="
    }
}

// Response
{
    "id": 1,
    "jsonrpc": "2.0",
    "result": {
        "version": "1",
        "appMetadata": {
            "name": "My Wallet"
        },
        "networks": [{
            "chainId": "icp:737ba355e855bd4b61279056603e0550"
        }],
        "scopes": ["canister_call"],
        "identity": {
            "publicKey": "MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAEOTdHYwpFTr/oPXOfLQcteymk8AQE41VwPQ1W7Xpm0Zt1AY4+5aOnMAbAIjXEchxPuGbPWqPqwntXMPs3w4rOaA==" /* principal: 2mdal-aedsb-hlpnv-qu3zl-ae6on-72bt5-fwha5-xzs74-5dkaz-dfywi-aqe */
        },
        "signature": "bldf7qn7DC5NzTyX5kp4GpZHaEncE5/6n/Y8av3xjEwIVFAwmhyW0uM+WBXRTj4QbScot04dfaBXUOcSWF0IjQ=="
    }
}
```

### `canister_call`

Once the connection between the relying party and the wallet is established, and the relying party has been granted the `canister_call` permission scope, the relying party can request the wallet to execute canister calls.

#### Types

- `text`: A plain `string` value.
- `blob`: A `string` value describing binary data encoded in base64.
- `nat`: A `string` value of an unsigned 64-bit integer.

#### Request

`version` (`text`): The version of the standard used.

`network`: Network details on which the call should be executed.
- `chainId` (`text`) - The chain id of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`canisterId` (`text`): The id of the canister on which the call should be executed.

`sender` (`text`): The principal requested to execute the call.

`method` (`text`): The name of the call method to be executed.

`arg` (`blob`): The arguments for the call.


#### Response

`version` (`text`): The version of the standard used.

`network`: Network details on which the call was executed.
- `chainId` (`text`): The chain id of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`contentMap`: The actual request content as specified [here](https://internetcomputer.org/docs/current/references/ic-interface-spec/#http-call).
- `request_type` (`text`)
- `sender` (`blob`)
- `nonce` (`blob`, optional)
- `ingress_expiry` (`nat`)
- `canister_id` (`blob`)
- `method_name` (`text`)
- `arg` (`blob`)

`certificate` (`blob`): The certificate returned by the `read_state` call as specified [here](https://internetcomputer.org/docs/current/references/ic-interface-spec/#certificate). The value is CBOR-encoded.

#### Use-Case

1. The relying party sends a `canister_call` request to the wallet.
2. Upon receiving the request, the wallet validates whether the relying party has the permission to request the action and processes the message following the [ICRC-21]() specification.
    - If the user approves the request:
        - The wallet sends the call to the IC (in order to get a certified results, all calls, including queries, should be sent as `update` calls), retrieves its [content map](https://internetcomputer.org/docs/current/references/ic-interface-spec/#http-call) and [calculates a request id](https://internetcomputer.org/docs/current/references/ic-interface-spec/#request-id) based on it.
        - The wallet continues to call `read_state` for the calculated request id until [the status of the call](https://internetcomputer.org/docs/current/references/ic-interface-spec/#state-tree-request-status) indicates that the call has been processed (succesfully or not).
            - If the status of the call is `replied`, the wallet retrieves the CBOR-encoded [certificate](https://internetcomputer.org/docs/current/references/ic-interface-spec/#certificate) from [the `read_state` response](https://internetcomputer.org/docs/current/references/ic-interface-spec/#http-read-state) and sends it together with the content map in response back to the relying party.
            - If the status of the call indicates the call failed, the wallet sends a response with an error back to the relying party.
    - If the user rejects the request or if the wallet fails to complete the requested action for any reason, the wallet sends a response with an error back to the relying party.
3. If the response is successful, the relying party verifies whether the call performed by the wallet was genuine and retrieves the result:
    - The relying party retrieves the `contentMap` from the response, verifies that its values match the expectations and uses it to [calculate a request id](https://internetcomputer.org/docs/current/references/ic-interface-spec/#request-id).
    - The relying party retrieves the CBOR-encoded [`certificate`](https://internetcomputer.org/docs/current/references/ic-interface-spec/#certificate) from the response, decodes it and validates its authenticity with regard to [the root of trust](https://internetcomputer.org/docs/current/references/ic-interface-spec/#root-of-trust).
        - If the validation process fails, the relying party rejects the response.
    - The relying party uses the calculated request id to retrieve [the `reply` blob](https://internetcomputer.org/docs/current/references/ic-interface-spec/#state-tree-request-status) from the `certificate`'s state tree.
        - If the `reply` blob is not present, the relying party rejects the response.

#### Example

```json
// Request
{
    "id": 1,
    "jsonrpc": "2.0",
    "method": "canister_call",
    "params": {
        "version": "1",
        "network": {
            "chainId": "icp:737ba355e855bd4b61279056603e0550",
        },
        "canisterId": "bkyz2-fmaaa-aaaaa-qaaaq-cai",
        "sender": "2mdal-aedsb-hlpnv-qu3zl-ae6on-72bt5-fwha5-xzs74-5dkaz-dfywi-aqe",
        "method": "transfer",
        "arg": "RElETARte24AbAKzsNrDA2ithsqDBQFsA/vKAQKi3pTrBgHYo4yoDX0BAwEdrH2v4C9riZI1Ss2DBLYdFDnt53DN2OUDJIiEgQIAAOgH"
    }
}

// Response
{
    "id": 1,
    "jsonrpc": "2.0",
    "result": {
        "version": "1",
        "network": {
            "chainId": "icp:737ba355e855bd4b61279056603e0550",
        },
        "contentMap": {
            "request_type": "call",
            "sender": "g5BOt7awpvKwE85v9Bn0tjg7fMv86NQMjLiyAQI=",
            "nonce": "AAABihipQ2wfDXuJIT9dtQ==",
            "ingress_expiry": "1692631100652000000",
            "canister_id": "gAAAAAAQAAEBAQ==",
            "method_name": "transfer",
            "arg": "RElETARte24AbAKzsNrDA2ithsqDBQFsA/vKAQKi3pTrBgHYo4yoDX0BAwEdrH2v4C9riZI1Ss2DBLYdFDnt53DN2OUDJIiEgQIAAOgH"
        },
        "certificate": "2dn3omR0cmVlgwGDAYIEWCDbGqoAWNjUIoTvYJXJ1d7kXYQxwJNfo38JT65LLVkZsoMBgwJOcmVxdWVzdF9zdGF0dXODAlgg7MfguoW+I0iJuMBdVigbtth22JBuAAqm0C39alKLmsqDAYMCRXJlcGx5ggNYq0RJREwBawK8igF9xf7SAXEBAAGWAUlDUkMtMiBBZ2VudCBlcnJvcjogKENhbmlzdGVyRXJyb3IsICJJQzA1MDM6IENhbmlzdGVyIHJ5amwzLXR5YWFhLWFhYWFhLWFhYWJhLWNhaSB0cmFwcGVkIGV4cGxpY2l0bHk6IElDUkMtMiBmZWF0dXJlcyBhcmUgbm90IGVuYWJsZWQgb24gdGhlIGxlZGdlci4iKYMCRnN0YXR1c4IDR3JlcGxpZWSCBFggD/rb0QsMZPXgOy0VFGgeQnUXoSwtK/M+hgO2pueq7UuDAYIEWCCPaMYe2OYoqQnR7mpSR6h2WzzA8byWm8yQKz1K6Y835IMCRHRpbWWCA0mgnuioz9nbvhdpc2lnbmF0dXJlWDCEOhywYNqcVJD3I1ZcEAfCw2FkwECK6qHzyPDuXetUHVLlRrezmD7iGK2eOP8krMw="
    }
}
```

### `error`

While processing a request from the relying party, the wallet can cancel it at any time by sending an error in response.

#### Response

`errorType` (`text`): The reason behind the cancellation. Possible values:
- `"ABORTED"`: The user has canceled the action.
- `"NETWORK_NOT_SUPPORTED"`: The network on which the action was requested is not supported by the wallet.
- `"NOT_GRANTED"`: The wallet has not granted permission to perform the action.
- `"NETWORK"`: The network call failed.
- `"UNKNOWN"`: The reason is unknown.

`description` (`text`, optional): An optional description of the error.


#### Example

```json
// Response
{
    "id": 1,
    "jsonrpc": "2.0",
    "error": {
        "version": "1",
        "errorType": "ABORTED",
        "description": "The user has rejected the request."
    }
}
```
