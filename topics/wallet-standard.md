# Wallet Standard

## Messages



### Permission

The purpose of the permission messages is to establish a connection between a relying party and a wallet.

#### Types

- `text`: A plain `string` value.
- `blob`: A `string` value describing binary data encoded in base64.

#### Request

`version` (`text`): The version of the standard used.

`senderId` (`text`): The ID of the sender. This should be used to identify the sender of the message.

`appMetadata`: Information about the relying party.
- `name` (`text`): The user-friendly name of the relying party. 
- `icon` (`text`, optional): An optional URL pointing to an icon resource representing the relying party.

`networks`: A list of networks on which the relying party plans to operate.
- `chainId`(`text`): The chain ID of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`scopes`: A list of permission scopes the relying party requires. Possible values: 
- `"canister_call"`

`challenge` (`blob`): A challenge used for the wallet to sign in order to prove its access to the identity.

#### Response

`version` (`text`): The version of the standard used.

`senderId` (`text`): The ID of the sender. This should be used to identify the sender of the message.

`appMetadata`: Information about the wallet.
- `name` (`text`): The user-friendly name of the wallet.
- `icon` (`text`, optional): An optional URL poiting to an icon resource representing the wallet.

`networks`: A list of networks on which the user has agreed the relying party can operate. This should be a subset of the `networks` from the original request.
- `chainId` (`text`): The chain ID of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`scopes`: A list of permission scopes that the user has agreed the relying party can be granted. This should be a subset of the `scopes` field from the original request. Possible values:
- `"canister_call"`

`principal` (`blob`): The principal associated with the identity the user has selected.

`ledger` (optional): Ledger data.
- `subaccount` (`blob`, optional)

`challenge` (`blob`): A challenge the wallet had to sign.

`signature` (`blob`): The signature of the challenge generated by the wallet.

#### Use-Case

1. The relying party sends a `permission` request to the wallet.
2. The wallet receives the message, presents the details of the to-be-established connection to the user and asks the user to select the identity that will be paired in response.
    - If the user approves the request, the wallet sends a succesful response back to the relying party.
    - If the user rejects the request, the wallet sends a response with an error back to the relying party.

#### Example

```json
// Request
{
    "id": 1,
    "jsonrpc": "2.0",
    "method": "permission",
    "params": {
        "version": "1",
        "senderId": "" /* TODO */,
        "appMetadata": {
            "name": "My DApp"
        },
        "networks": [{
            "chainId": "icp:737ba355e855bd4b61279056603e0550",
        }],
        "scopes": ["canister_call"],
        "challenge": "" /* TODO */
    }
}

// Response
{
    "id": 1,
    "jsonrpc": "2.0",
    "result": {
        "version": "1",
        "senderId": "" /* TODO */,
        "appMetadata": {
            "name": "My Wallet"
        },
        "networks": [{
            "chainId": "icp:737ba355e855bd4b61279056603e0550"
        }],
        "scopes": ["canister_call"],
        "principal": "" /* TODO */,
        "challenge": "" /* TODO */,
        "signature": "" /* TODO */
    }
}
```

### Canister Call

Once the connection between the relying party and wallet is established, the relying party can request the wallet to execute canister calls.

#### Types

- `text`: A plain `string` value.
- `blob`: A `string` value describing binary data encoded in base64.
- `HashTree`: A recursive type defined as a union of:
    - `[0]`: Empty Node.
    - `[1, HashTree, HashTree]`: Fork Node.
    - `[2, blob, HashTree]`: Labeled Node.
    - `[3, blob]`: Leaf Node.
    - `[4, blob]`: Pruned Node.

#### Request

`version` (`text`): The version of the standard used.

`senderId` (`text`): The ID of the sender. This should be used to identify the sender of the message.

`network`: Network details on which the call should be executed.
- `chainId` (`text`) - The chain ID of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`canisterId` (`text`): The ID of the canister on which the call should be executed.

`method` (`text`): The name of the call method to be executed.

`arg` (`blob`): The arguments for the call.


#### Response

`version` (`text`): The version of the standard used.

`senderId` (`text`): The ID of the sender. This should be used to identify the sender of the message.

`network`: Network details on which the call was executed.
- `chainId` (`text`): The chain ID of the network as described in the [CAIP-2]() standard.
- `name` (`text`, optional): An optional user-friendly name of the network.
- `rpcUrl` (`text`, optional): An optional custom RPC URL associated with the network.

`contentMap`: The actual request content as specified [here](https://internetcomputer.org/docs/current/references/ic-interface-spec/#http-call).
- `request_type` (`text`)
- `sender` (`blob`)
- `nonce` (`blob`, optional)
- `ingress_expiry` (`nat`)
- `canister_id` (`blob`)
- `method_name` (`text`)
- `arg` (`blob`)

`certificate`: The certificate returned by the `read_state` call as specified [here](https://internetcomputer.org/docs/current/references/ic-interface-spec/#certificate).
- `tree` (`HashTree`)
- `signature` (`blob`)
- `delegation` (optional)
    - `subnet_id` (`blob`)
    - `certificate` (`blob`)

#### Use-Case

1. The relying party sends `canister_call_request`.
2. The wallet receives the request, validates if the relying party has permission to request the action and processes the message (in accordance with the [ICRC-21]() specification).
    - If the user approves the request, the wallet sends the call to the IC and, upon receiving a successful response, sends a successful response back to the relying party.
    - If the user rejects the request or wallet fails to complete the requested action for any reason, the wallet sends a response with an error back to the relying party.
3. If the response is successful, the relying party calculates a [request id](https://internetcomputer.org/docs/current/references/ic-interface-spec/#request-id) based on the `contentMap` and uses it to get the final response from the `certificate`.

#### Example

```json
// Request
{
    "id": 1,
    "jsonrpc": "2.0",
    "method": "canister_call",
    "params": {
        "version": "1",
        "senderId": "" /* TODO */,
        "network": {
            "chainId": "icp:737ba355e855bd4b61279056603e0550",
        },
        "canisterId": "" /* TODO */,
        "method": "" /* TODO */,
        "arg": "" /* TODO */
    }
}

// Response
{
    "id": 1,
    "jsonrpc": "2.0",
    "result": {
        "version": "1",
        "senderId": "" /* TODO */,
        "network": {
            "chainId": "icp:737ba355e855bd4b61279056603e0550",
        },
        "contentMap": { /* TODO */ },
        "certificate": { /* TODO */ }
    }
}
```

### Error

While processing a request from the relying party, the wallet can cancel it at any time by sending an error in response.

#### Response

`errorType` (`text`): The reason behind the cancellation. Possible values:
- `"ABORTED"`: The user has canceled the action.
- `"NETWORK_NOT_SUPPORTED"`: The network on which the action was requested is not supported by the wallet.
- `"NOT_GRANTED"`: The wallet has not granted permission to perform the action.
- `"NETWORK"`: The network call failed.
- `"UNKNOWN"`: The reason is unknown.

`description` (`text`, optional): An optional description of the error.


#### Example

```json
// Response
{
    "id": 1,
    "jsonrpc": "2.0",
    "error": {
        "version": "1",
        "senderId": "" /* TODO */,
        "errorType": "ABORTED",
        "description": "The user has rejected the request."
    }
}
```
